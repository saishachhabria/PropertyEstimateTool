{% extends 'base.html' %}
{% load static %}
{% block title %}{{ estimate.project_name }} - Results{% endblock %}

{% block content %}

<div class="min-h-screen gradient-bg">
  <div class="container mx-auto px-4 py-8 max-w-4xl">
    
    <!-- Project Header Card -->
    <div class="bg-white rounded-4xl overflow-hidden shadow-lg mb-6">
      <!-- Hero Image -->
      <div class="h-56 md:h-72 relative overflow-hidden">
      <img src="{% static 'images/result_image.png' %}" alt="Farm">
        
        <!-- Overlay -->
        <div class="absolute bottom-4 left-4 right-4 flex justify-between items-end text-white">
          <div>
            <div class="text-sm font-medium drop-shadow-lg">
              {{ estimate.location }}
            </div>
          </div>
          <div class="text-right">
            <span class="text-lg font-bold drop-shadow-lg">
              {{ estimate.area_hectares|floatformat:0 }}
            </span>
            <span class="text-sm drop-shadow-lg">
              of {{ estimate.area_hectares|floatformat:0 }} ha
            </span>
          </div>
        </div>
      </div>
      
      <!-- Project Name -->
      <div class="text-center py-6">
        <h1 class="text-2xl md:text-3xl font-semibold text-primary-forest">
          {{ estimate.project_name }}
        </h1>
      </div>
    </div>

    <!-- Projected 10-Year Cash Flow Section -->
    <div class="mb-6">
      <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-4">
        Projected 10-Year Cash Flow
      </h2>

      <!-- Tab Navigation -->
      <div class="flex mb-6 bg-gray-100 rounded-full p-1">
        <button id="cashFlowTab" 
                class="tab-button active flex-1 py-3 px-6 text-sm font-semibold rounded-full transition-all">
          Cash Flow
        </button>
        <button id="revenueTab" 
                class="tab-button flex-1 py-3 px-6 text-sm font-semibold rounded-full transition-all">
          Revenue  
        </button>
        <button id="costTab" 
                class="tab-button flex-1 py-3 px-6 text-sm font-semibold rounded-full transition-all">
          Cost
        </button>
      </div>

      <!-- Description -->
      <div class="text-sm text-gray-600 mb-6 leading-relaxed">
        {{ estimate.project_description|truncatewords:25 }}
      </div>

      <!-- Charts Container -->
      <div class="bg-white rounded-2xl p-6 mb-6 shadow-sm">
        
        <!-- Cash Flow Chart -->
        <div id="cashFlowChart" class="chart-container">
          <h3 class="text-center text-sm font-medium text-gray-700 mb-6">
            Net Cash Flow (USD) per Year
          </h3>
          <div class="relative h-64 mb-6">
            
            <!-- Y-axis -->
            <div class="absolute left-0 top-0 h-full w-12 flex flex-col justify-between text-xs text-gray-500">
              <span>$50K</span>
              <span>$25K</span>
              <span>$12.5K</span>
              <span class="font-semibold">0</span>
              <span>-$12.5K</span>
            </div>

            <!-- Bars -->
            <div class="absolute left-12 right-0 top-0 h-full border-l-2 border-b-2 border-gray-300">
              <div id="chartBars" class="h-full flex items-end justify-between px-4"></div>
            </div>

            <!-- X-axis -->
            <div class="absolute left-12 right-0 -bottom-6 flex justify-between text-xs text-gray-600 px-4">
              {% for year_data in estimate.yearly_financials %}
                <span>{{ year_data.year }}</span>
              {% endfor %}
            </div>
          </div>
          <p class="text-xs text-gray-500 text-center italic">
            Estimates only. More data will improve accuracy.
          </p>
        </div>

        <!-- Revenue Chart -->
        <div id="revenueChart" class="chart-container hidden">
          <h3 class="text-center text-sm font-medium text-gray-700 mb-6">
            Revenue Breakdown (USD) per Year
          </h3>
          <div class="h-64 mb-6 flex items-center justify-center">
            <p class="text-gray-400">Revenue breakdown chart</p>
          </div>
        </div>

        <!-- Cost Chart -->
        <div id="costChart" class="chart-container hidden">
          <h3 class="text-center text-sm font-medium text-gray-700 mb-6">
            Total Costs (USD) per Year
          </h3>
          <div class="h-64 mb-6 flex items-center justify-center">
            <p class="text-gray-400">Cost analysis chart</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Financial Data Table -->
    <div class="bg-white rounded-2xl shadow-sm overflow-hidden mb-6">
      <div class="bg-primary-forest text-primary-mindaro">
        <div class="grid grid-cols-4 gap-3 p-4 text-sm font-semibold">
          <div>Year</div>
          <div>Total Revenue</div>
          <div>Total Costs</div>
          <div>Net Cash Flow</div>
        </div>
      </div>

      <div class="divide-y divide-gray-100">
        {% for year_data in estimate.yearly_financials %}
        <div class="grid grid-cols-4 gap-3 p-4 text-sm hover:bg-gray-50 transition-colors">
          <div class="font-semibold text-gray-900">{{ year_data.year }}</div>
          <div class="text-gray-700">${{ year_data.total_revenue|floatformat:0 }}</div>
          <div class="text-gray-700">${{ year_data.total_costs|floatformat:0 }}</div>
          <div class="font-semibold {% if year_data.net_cash_flow > 0 %}text-green-600{% else %}text-red-600{% endif %}">
            {% if year_data.net_cash_flow > 0 %}+{% endif %}${{ year_data.net_cash_flow|floatformat:0 }}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<style>
.tab-button {
  background: transparent;
  color: #6b7280;
}
.tab-button.active {
  background: #1B2210;
  color: #EFFE8B;
}
.chart-bar {
  transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  transform-origin: bottom;
}
.chart-bar:hover {
  opacity: 0.8;
  transform: scaleY(1.05);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Injected from Django
  const financialData = estimate.get_chart_data|safe|"[]";

  const tabs = {
    cashFlow: document.getElementById('cashFlowTab'),
    revenue: document.getElementById('revenueTab'),
    cost: document.getElementById('costTab')
  };
  const charts = {
    cashFlow: document.getElementById('cashFlowChart'),
    revenue: document.getElementById('revenueChart'),
    cost: document.getElementById('costChart')
  };

  function showTab(activeTab) {
    Object.entries(charts).forEach(([key, chart]) => {
      if (key === activeTab) {
        chart.classList.remove('hidden');
        tabs[key].classList.add('active');
      } else {
        chart.classList.add('hidden');
        tabs[key].classList.remove('active');
      }
    });
  }

  tabs.cashFlow.addEventListener('click', () => showTab('cashFlow'));
  tabs.revenue.addEventListener('click', () => showTab('revenue'));
  tabs.cost.addEventListener('click', () => showTab('cost'));

  function generateChartBars() {
    const chartBars = document.getElementById('chartBars');
    if (!chartBars || !financialData.length) return;

    chartBars.innerHTML = '';
    const maxValue = 50000;

    financialData.forEach((yearData) => {
      const netCashFlow = parseFloat(yearData.net_cash_flow) || 0;
      const barHeight = Math.max(Math.abs(netCashFlow) / maxValue * 100, 2);

      const barContainer = document.createElement('div');
      barContainer.className = 'flex flex-col items-center flex-1 mx-1';

      const bar = document.createElement('div');
      bar.className = `chart-bar w-full ${netCashFlow >= 0 ? 'bg-green-500 rounded-t' : 'bg-red-500 rounded-b'}`;
      bar.style.height = `${barHeight}%`;

      if (netCashFlow < 0) {
        barContainer.style.justifyContent = 'flex-end';
      }

      barContainer.appendChild(bar);
      chartBars.appendChild(barContainer);
    });
  }

  generateChartBars();
});
</script>
{% endblock %}
